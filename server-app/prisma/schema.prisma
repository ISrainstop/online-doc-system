// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  passwordHash  String
  email         String?   @unique
  role          String    @default("USER") // å¯é€‰å€¼: 'USER', 'ADMIN'
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // å…³ç³»å­—æ®µ
  documents     Document[]             // ç”¨æˆ·åˆ›å»ºçš„æ–‡æ¡£
  collaborations DocumentCollaborator[] // ç”¨æˆ·å‚ä¸åä½œçš„æ–‡æ¡£
  
  // ğŸ”¥ æ–°å¢ï¼šç”¨æˆ·åˆ›å»ºçš„å†å²ç‰ˆæœ¬ (è§£å†³ Error: missing opposite relation field)
  createdVersions DocumentVersion[]    
}

model Document {
  id            String   @id @default(uuid())
  title         String
  content       Json?
  contentText   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isDeleted     Boolean  @default(false)

  // å…³è”ï¼šåˆ›å»ºè€…
  createdById   String
  // ğŸ”¥ ä¿®æ”¹è¿™é‡Œï¼šæ·»åŠ  onDelete: Cascade
  // å«ä¹‰ï¼šå¦‚æœç”¨æˆ·è¢«åˆ ï¼Œä»–åˆ›å»ºçš„æ–‡æ¡£ä¹Ÿä¼šè¿å¸¦è¢«ç‰©ç†åˆ é™¤
  createdBy     User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // å…³è”ï¼šåä½œè€…
  collaborators DocumentCollaborator[]

  // ç‰ˆæœ¬å†å²
  versions      DocumentVersion[]
}

model DocumentCollaborator {
  id          String   @id @default(uuid())
  documentId  String
  userId      String
  permission  String   // 'VIEW' | 'EDIT' | 'OWNER'
  createdAt   DateTime @default(now())

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
}

// ğŸ”¥ æ–°å¢ï¼šç‰ˆæœ¬å†å²è¡¨
model DocumentVersion {
  id          String   @id @default(uuid())
  content     Json     
  versionName String?
  createdAt   DateTime @default(now())

  // å…³è”ï¼šæ‰€å±æ–‡æ¡£
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // å…³è”ï¼šè°åˆ›å»ºçš„è¿™ä¸ªç‰ˆæœ¬
  createdById String?
  // ğŸ”¥ ä¿®æ”¹è¿™é‡Œï¼šæ·»åŠ  onDelete: SetNull
  // å«ä¹‰ï¼šå¦‚æœç”¨æˆ·è¢«åˆ ï¼Œä»–åˆ›å»ºçš„å†å²ç‰ˆæœ¬è®°å½•ä¿ç•™ï¼Œä½†åˆ›å»ºè€…å­—æ®µå˜ä¸ºç©º (å› ä¸ºè¿™ä¸ªç‰ˆæœ¬å¯èƒ½å±äºåˆ«äººçš„æ–‡æ¡£)
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
}